<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.1. 多媒体问题排查手册 &mdash; SOPHON and SDK FAQ master
 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" /><link rel="stylesheet" href="../_static/css/nav.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <script src="../_static/js/qrious.js"></script>
    <script src="../_static/js/nav.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="5.2. 多媒体客户常见问题" href="Multimedia_FAQ.html" />
    <link rel="prev" title="5. 多媒体用户常见问题" href="../5_multimedia.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> SOPHON and SDK FAQ
          </a>
              <div class="version">
                master

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../0_disclaimer.html">1. 声明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_basic_concept.html">2. 基础概念常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_device_usages.html">3. 设备使用常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_converter_quantization.html">4. 模型转换及量化常见问题</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../5_multimedia.html">5. 多媒体用户常见问题</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.1. 多媒体问题排查手册</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">5.1.1. 名词定义</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ffmpeg">5.1.2. FFmpeg问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">5.1.2.1. ffmpeg拉流问题</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">5.1.2.2. ffmpeg解码问题</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">5.1.2.3. ffmpeg编码/转码问题</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">5.1.2.4. ffmpeg推流问题</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">5.1.2.5. ffmpeg综合问题</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bmcv">5.1.3. BMCV问题</a></li>
<li class="toctree-l3"><a class="reference internal" href="#opencv">5.1.4. OpenCV问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id10">5.1.4.1. OpenCV拉流、解码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">5.1.4.2. OpenCV图像处理</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sail">5.1.5. SAIL问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sail-decoder">5.1.5.1. sail.Decoder解码</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sail-encoder">5.1.5.2. sail.Encoder编码</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#related-resources">5.1.6. Related Resources</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Multimedia_FAQ.html">5.2. 多媒体客户常见问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="multimedia_general_faq.html">5.3. 多媒体客户常见问题（补充）</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../6_program_optimization.html">6. 程序开发常见问题</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SOPHON and SDK FAQ</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../5_multimedia.html"><span class="section-number">5. </span>多媒体用户常见问题</a> &raquo;</li>
      <li><span class="section-number">5.1. </span>多媒体问题排查手册</li>
      <li class="wy-breadcrumbs-aside">
            <!-- <a href="../_sources/multimedia/multimedia_troubleshooting.rst.txt" rel="nofollow"> View page source</a> -->
            <a href="https://developer.sophon.cn/document/index.html" rel="nofollow">返回文档中心</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">5.1. </span>多媒体问题排查手册</a><a class="headerlink" href="#id1" title="此标题的永久链接">¶</a></h1>
<nav class="contents" id="id2">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#id1" id="id12">多媒体问题排查手册</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id13">名词定义</a></p></li>
<li><p><a class="reference internal" href="#ffmpeg" id="id14">FFmpeg问题</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id15">ffmpeg拉流问题</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id16">ffmpeg解码问题</a></p>
<ul>
<li><p><a class="reference internal" href="#ffmpeg-c" id="id17">ffmpeg C++开发问题</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id18">ffmpeg 命令行问题</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id19">ffmpeg编码/转码问题</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id20">ffmpeg推流问题</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id21">ffmpeg综合问题</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#bmcv" id="id22">BMCV问题</a></p></li>
<li><p><a class="reference internal" href="#opencv" id="id23">OpenCV问题</a></p>
<ul>
<li><p><a class="reference internal" href="#id10" id="id24">OpenCV拉流、解码</a></p></li>
<li><p><a class="reference internal" href="#id11" id="id25">OpenCV图像处理</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sail" id="id26">SAIL问题</a></p>
<ul>
<li><p><a class="reference internal" href="#sail-decoder" id="id27">sail.Decoder解码</a></p></li>
<li><p><a class="reference internal" href="#sail-encoder" id="id28">sail.Encoder编码</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#related-resources" id="id29">Related Resources</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="id3">
<h2><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">5.1.1. </span>名词定义</a><a class="headerlink" href="#id3" title="此标题的永久链接">¶</a></h2>
<p>任务</p>
<ul class="simple">
<li><p>拉流</p>
<ul>
<li><p>拉流是指从视频服务器或者流媒体服务器上获取视频数据的过程。拉流本身不涉及解码。主要涉及网络和CPU。</p></li>
</ul>
</li>
<li><p>解码</p>
<ul>
<li><p>解码是将压缩的视频数据转换回可观看的视频画面的过程。简而言之，它是将编码的视频数据（通常体积较小，便于传输）转换为可以在屏幕上显示的视频帧。主要涉及VPU。</p></li>
</ul>
</li>
<li><p>编码</p>
<ul>
<li><p>编码是将视频画面转换成压缩的数据格式的过程。这样做可以减小视频文件的大小，便于存储和传输。主要涉及VPU。</p></li>
</ul>
</li>
<li><p>转码</p>
<ul>
<li><p>解码再编码。主要涉及VPU。</p></li>
</ul>
</li>
<li><p>推流</p>
<ul>
<li><p>推流是指将本地的视频数据发送到流媒体服务器或者其他接收端的过程。推流本身不涉及编码。主要涉及网络和CPU。</p></li>
</ul>
</li>
</ul>
<p>模式</p>
<ul class="simple">
<li><p>命令行</p>
<ul>
<li><p>在命令行中使用ffmpeg完成某些任务。</p></li>
</ul>
</li>
<li><p>C++开发</p>
<ul>
<li><p>使用FFmpeg / OpenCV / SAIL 提供的接口开发程序。</p></li>
</ul>
</li>
<li><p>Python开发</p>
<ul>
<li><p>使用SAIL / OpenCV 提供的接口开发程序。</p></li>
</ul>
</li>
</ul>
</section>
<section id="ffmpeg">
<h2><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">5.1.2. </span>FFmpeg问题</a><a class="headerlink" href="#ffmpeg" title="此标题的永久链接">¶</a></h2>
<section id="id4">
<h3><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">5.1.2.1. </span>ffmpeg拉流问题</a><a class="headerlink" href="#id4" title="此标题的永久链接">¶</a></h3>
<ol class="arabic">
<li><p>rtsp method DESCRIBE failed 401 Unauthorized
RTSP认证错误。</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>首先检查用户名或者密码是否正确。</p></li>
<li><p>检查用户名和密码是否含有特殊字符。对于 <code class="docutils literal notranslate"><span class="pre">rtsp://{user}:{passwd}&#64;{ip}:{port}/{path}</span></code> 形式的RTSP地址，如果user和peasswd中含有 “<cite>+</cite>””<cite>#</cite>””<cite>%</cite>””<cite>&#64;</cite>”等字符，需要把特殊字符用URL Encoding替换。</p></li>
</ol>
</div></blockquote>
</li>
<li><p>method SETUP failed: 461 Unsuported transport
使用了不支持的传输协议。</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>测试 <cite>ffmpeg -rtsp_transport tcp -i &lt;rtsp://xxx&gt;</cite> 。如果失败，说明该RTSP只支持UDP，不支持TCP。</p></li>
<li><p>测试 <cite>ffmpeg -rtsp_transport udp -i &lt;rtsp://xxx&gt;</cite> 。如果失败，说明该RTSP只支持TCP，不支持UDP。</p></li>
</ol>
</div></blockquote>
</li>
<li><p>connect to xxx failed: Connection refused
网络问题</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>检查RTSP对应的推流服务器是否开启</p></li>
<li><p>ping RTSP的IP，是否能连通</p></li>
<li><p>检查ip、网关等是否正确配置</p></li>
</ol>
</div></blockquote>
</li>
<li><p>确认该RTSP是否支持被多个客户端拉流</p></li>
<li><p>拉流失败的保底排查方案</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>如果上面的问题都排查过了，大概率就是网络问题了，而非ffmpeg或者设备硬件问题。</p></li>
<li><p>可以用公版ffmpeg拉流。 <a class="reference external" href="https://www.johnvansickle.com/ffmpeg/old-releases/">Index of /ffmpeg/old-releases (johnvansickle.com)</a></p></li>
</ol>
</div></blockquote>
</li>
</ol>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id16" role="doc-backlink"><span class="section-number">5.1.2.2. </span>ffmpeg解码问题</a><a class="headerlink" href="#id5" title="此标题的永久链接">¶</a></h3>
<section id="ffmpeg-c">
<h4><a class="toc-backref" href="#id17" role="doc-backlink"><span class="section-number">5.1.2.2.1. </span>ffmpeg C++开发问题</a><a class="headerlink" href="#ffmpeg-c" title="此标题的永久链接">¶</a></h4>
<ol class="arabic">
<li><p>VPU_DecGetOutputInfo decode fail framdIdx xxx error 某一帧解码失败，一般是这一帧不合法，原因一般在：</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>rtsp流默认为udp协议，有丢包。命令中解码参数加上 -rtsp_transport tcp。</p></li>
<li><p>网络带宽较小，多路解码带宽占满，造成丢包。</p></li>
<li><p>设备解码能力到达上限了。这里说的”上限”，未必是VPU本身的硬件性能到上限了。比如，有可能是上层代码没有合理利用CPU等资源，导致VPU不能完全发挥性能。比如，如果使用ffmpeg命令行执行RTSP拉流解码+编码，而没有设置硬编码，因为A53编码较慢，编码阻塞，进而影响解码的调度，出现数据丢失。这时修改命令调用VPU硬编码可以解决。</p></li>
<li><p>推流不稳定。可以用VLC播放，观察是否有花屏。</p></li>
</ol>
</div></blockquote>
</li>
<li><p>Invalid NAL unit 0, skipping / missing picture in access unit /Failed to DEC_PIC_HDR(ERROR REASON: 00005000) error code is 0x1 / InstIdx 0: BMVidDecSeqInitW5 failed Error code is 0x1 / Invalid NAL unit size / Error splitting the input into NAL units</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>检查解码器是否匹配。比如，是否输入文件为h265编码而指定了-c:v h264_bm，或者输入文件是mpeg4编码而指定了-c:v h264_bm</p></li>
</ol>
</div></blockquote>
</li>
<li><p>no frame / missing picture in access unit with size / data partitioning is not implemented</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>检查解码器是否匹配。比如，是否输入文件为h264编码而指定了-c:v hevc_bm</p></li>
</ol>
</div></blockquote>
</li>
<li><p>bm_alloc_gmem failed</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>内存满了。一般是VPU内存满了。可以考虑使用压缩格式output_format 101，或者适当减小extra_frame_buffer_num，或者修改内存布局。</p></li>
<li><p>句柄到上限了。ulimit -n 查看当前环境句柄上限，如果是1024很可能不够用。ulimit -n {num} 修改上限，一般65536够用了。</p></li>
</ol>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">avcodec_receive_frame</span></code> 返回错误码 -11</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>-11对应EAGAIN，Resource temporarily unavailable， <a class="reference external" href="https://ffmpeg.org/doxygen/trunk/error_8c_source.html">https://ffmpeg.org/doxygen/trunk/error_8c_source.html</a></p></li>
<li><p>在ffmpeg中，发生在解码阶段时，表示送入的pkt不够解出一帧frame出来，需要继续send</p></li>
<li><p>解决方法是用while继续send pakcet</p></li>
</ol>
</div></blockquote>
</li>
</ol>
</section>
<section id="id6">
<h4><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">5.1.2.2.2. </span>ffmpeg 命令行问题</a><a class="headerlink" href="#id6" title="此标题的永久链接">¶</a></h4>
<ol class="loweralpha simple">
<li><p>基本测试命令</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#1. 网络流</span>
ffmpeg<span class="w"> </span>-rtsp_transport<span class="w"> </span>tcp<span class="w"> </span>-i<span class="w"> </span>rtsp://xxx<span class="w"> </span>-f<span class="w"> </span>rawvideo<span class="w"> </span>-y<span class="w"> </span>/dev/null

ffmpeg<span class="w"> </span>-rtsp_transport<span class="w"> </span>udp<span class="w"> </span>-i<span class="w"> </span>rtsp://xxx<span class="w"> </span>-f<span class="w"> </span>rawvideo<span class="w"> </span>-y<span class="w"> </span>/dev/null

ffmpeg<span class="w"> </span>-rtsp_transport<span class="w"> </span>tcp<span class="w"> </span>-extra_frame_buffer_num<span class="w"> </span><span class="m">5</span><span class="w"> </span>-i<span class="w"> </span>rtsp://xxx<span class="w"> </span>-c:v<span class="w"> </span>h264_bm<span class="w"> </span>-b:v<span class="w"> </span>3M<span class="w"> </span>-vframes<span class="w"> </span><span class="m">500</span><span class="w"> </span>out.mp4

<span class="c1">#2. 本地视频</span>
ffmpeg<span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>input<span class="o">}</span><span class="w"> </span>-f<span class="w"> </span>rawvideo<span class="w"> </span>-y<span class="w"> </span>/dev/null

ffmpeg<span class="w"> </span>-extra_frame_buffer_num<span class="w"> </span><span class="m">5</span><span class="w"> </span>-i<span class="w"> </span><span class="o">{</span>input<span class="o">}</span><span class="w"> </span>-c:v<span class="w"> </span>h264_bm<span class="w"> </span>-b:v<span class="w"> </span>3M<span class="w"> </span><span class="o">{</span>output<span class="o">}</span>
</pre></div>
</div>
<ol class="loweralpha" start="2">
<li><p>RTSP拉流解码卡住，不报错</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>多见于大华、海康的RTSP</p></li>
<li><p>如果RTSP的地址有些特殊符号，要注意命令行解析字符串的时候可能出错，解决方法是给RTSP地址加上引号 <code class="docutils literal notranslate"><span class="pre">&quot;rtsp://...&quot;</span></code></p></li>
</ol>
</div></blockquote>
</li>
<li><p>解码失败的保底排查方案</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>保存原始码流，拿到本地分析码流。有以下两种保存方式。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ffmpeg</span> <span class="pre">-rtsp_transport</span> <span class="pre">tcp</span> <span class="pre">-i</span> <span class="pre">rtsp://xxx</span> <span class="pre">-c</span> <span class="pre">copy</span> <span class="pre">-vframes</span> <span class="pre">500</span> <span class="pre">saved.264</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">echo</span> <span class="pre">&quot;0</span> <span class="pre">0</span> <span class="pre">1000</span> <span class="pre">0&quot;</span> <span class="pre">&gt;</span> <span class="pre">/proc/vpuinfo</span></code>   参数1：0 core idx；参数2：0 instance idx；参数3：输入num（保存的帧数）；参数4：输出num（保存的yuv）；执行编解码，然后dump的文件在/data/core_%dinst%d_stream%d.bin</p></li>
</ol>
</div></blockquote>
</li>
</ol>
</section>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">5.1.2.3. </span>ffmpeg编码/转码问题</a><a class="headerlink" href="#id7" title="此标题的永久链接">¶</a></h3>
<ol class="arabic">
<li><dl class="simple">
<dt>ffmpeg命令行转码卡住、阻塞</dt><dd><ol class="arabic simple">
<li><p>出现阻塞现象时，命令一般是 <code class="docutils literal notranslate"><span class="pre">ffmpeg</span> <span class="pre">-i</span> <span class="pre">{input}</span> <span class="pre">-c:v</span> <span class="pre">h264_bm</span> <span class="pre">-b:v</span> <span class="pre">3M</span> <span class="pre">{output}</span></code></p></li>
<li><p>VPU内部维护了一个ring buffer供解码和编码使用。编码一般需要若干个缓存帧。如果设置buffer num过小，buffer被编码全部占用而不释放，解码和编码就会阻塞。</p></li>
<li><p>解决方法是，通过 <code class="docutils literal notranslate"><span class="pre">-extra_frame_buffer_num</span> <span class="pre">{buffer_num}</span></code> 增大缓存buffer。</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>ERROR! Invalid pic data</dt><dd><ol class="arabic simple">
<li><p>送给编码器的frame是空的。</p></li>
<li><p>对于命令行，比如从rawvideo（一般是从摄像头或本地文件）读数据，数据在系统内存上，VPU默认从设备内存读数据，所以读不到有效数据，改成is_dma_buffer 0可以解决。</p></li>
<li><p>对于C++开发，如果is_dma_buffer=1，检查设备内存（data[4-7]），如果is_dma_buffer=0，检查系统内存（data[0-3]）</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>编码得到的视频播放时回退或者帧顺序不对</dt><dd><ol class="arabic simple">
<li><p><a class="reference internal" href="Multimedia_FAQ.html#id15"><span class="std std-ref">ffmpeg中做图像格式/大小变换导致视频播放时回退或者顺序不对的情况处理办法</span></a></p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>ffmpeg <strong>C++开发</strong> ，编码绿屏、花屏</dt><dd><ol class="arabic simple">
<li><p>编码的核心数据结构是AVFrame，sophon-ffmpeg对公版AVFrame做了拓展，见文档 <a class="reference external" href="https://doc.sophgo.com/sdk-docs/v23.09.01-lts/docs_latest_release/docs/sophon-mw/guide/html/guide/Multimedia_Guide_zh.html#avframe">2.3.7. AVFrame特殊定义说明 – Multimedia v23.10.01 文档</a> 。简单来说，data[0-3]保存了系统内存地址，data[4-7]保存了设备内存地址。一般来说，VPU用的是data[4-7]，不会需要用系统内存。</p></li>
<li><dl class="simple">
<dt>如果编码出错，可以排查以下几点：</dt><dd><ol class="arabic simple">
<li><p>确认is_dma_buffer的值，是0还是1。默认为1，表示用设备内存编码，设置为0表示从系统内存编码。</p></li>
<li><p>如果is_dma_buffer==1，检查data[4-7]。主要检查两点：1.内存地址是否正确。对于84&amp;X，VPU要求输入在VPU heap上，也就是heap 2 / DDR 1，对应的addr 一般为0x3_8000_0000~0x4_0000_0000。 2. 内存上的像素值是否正确。具体方法是，把对应plane的内存d2s，然后看像素值是否和期望的画面相符，可以gdb也可以fwrite/ofstream。</p></li>
<li><p>如果is_dma_buffer==0，检查data[0-3]内存上的像素值。</p></li>
<li><p>如果上述检查都没问题，但编码出错，还可以考虑是否编码结束之前内存被释放了。</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
</li>
<li><p>ffmpeg <strong>命令行</strong> ，解码后保存视频或者图片，画面是 <strong>绿屏</strong> 或者 <strong>花屏</strong></p>
<blockquote>
<div><ol class="arabic">
<li><p>整个过程是先解码、再编码，解码后的内存没有被编码器正确地读取，这是该问题的根本原因。</p></li>
<li><p>“正确地读取” = <strong>( 编码器和解码器都使用设备内存 || 编码器和解码器都使用设备内存 || 解码器和编码器使用的内存不一致但做了内存拷贝)</strong></p></li>
<li><dl>
<dt>举例 <code class="docutils literal notranslate"><span class="pre">ffmpeg</span> <span class="pre">-rtsp_transport</span> <span class="pre">tcp</span> <span class="pre">-i</span>&#160; <span class="pre">&quot;rtsp://&quot;</span>&#160; <span class="pre">-vframes</span> <span class="pre">1</span> <span class="pre">frame.jpg</span></code></dt><dd><ol class="arabic">
<li><p>ffmpeg默认调用VPU硬件解码视频，且默认zero_copy=1，所以解码后的数据  <strong>只</strong> 在VPU  <strong>设备</strong> 内存上。</p></li>
<li><p>输出为jpeg，编码器默认用软编码，从  <strong>系统</strong> 内存读数据。如果这块内存是全0，由于YUV和RGB的色彩对应关系，画面表现为绿屏。如果这块内存最近被用过，可能是一块非零的值，画面表现为花屏。</p></li>
<li><dl>
<dt>解决方法：</dt><dd><ol class="arabic">
<li><dl class="simple">
<dt>调用硬件编码器jpeg_bm，且因为JPU直接读VPU的数据可能有问题，所以要通过zero_copy选项做一次数据拷贝，并通过is_dma_buffer选项指明JPU的输入来源。</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ffmpeg</span> <span class="pre">-rtsp_transport</span> <span class="pre">tcp</span> <span class="pre">-zero_copy</span> <span class="pre">0</span> <span class="pre">-i</span> <span class="pre">&quot;rtsp://&quot;</span> <span class="pre">-c:v</span> <span class="pre">jpeg_bm</span> <span class="pre">-is_dma_buffer</span> <span class="pre">0</span> <span class="pre">-vframes</span> <span class="pre">1</span> <span class="pre">frame.jpg</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>也可以选择调用软编码，那么只需要通过zero_copy做一次拷贝，让CPU能读到数据即可。这个方案缺点是，编码性能较低。</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ffmpeg</span> <span class="pre">-rtsp_transport</span> <span class="pre">tcp</span> <span class="pre">-zero_copy</span> <span class="pre">0</span> <span class="pre">-i</span> <span class="pre">&quot;rtsp://&quot;</span> <span class="pre">-vframes</span> <span class="pre">1</span> <span class="pre">frame.jpg</span></code></p></li>
</ul>
</div></blockquote>
</li>
</ol>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
</li>
</ol>
</div></blockquote>
</li>
</ol>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">5.1.2.4. </span>ffmpeg推流问题</a><a class="headerlink" href="#id8" title="此标题的永久链接">¶</a></h3>
<ol class="arabic simple">
<li><dl class="simple">
<dt>流服务器如何搭建</dt><dd><ol class="arabic simple">
<li><p>Mediamtx，开源、轻量、易上手，适合简单验证，但性能和稳定性略差。</p></li>
<li><p>Live555，稳定，适合性能测试，或者测试业务程序全流程。</p></li>
<li><p>ZLMediaKit</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">5.1.2.5. </span>ffmpeg综合问题</a><a class="headerlink" href="#id9" title="此标题的永久链接">¶</a></h3>
<ol class="arabic simple">
<li><dl class="simple">
<dt>拉流解码，一开始正常，一段时间后报错</dt><dd><ol class="arabic simple">
<li><p>不管用ffmpeg还是opencv拉流解码，每两次拉流read()的时间间隔一定要小于两帧的时间间隔（25FPS -&gt; 40ms）</p></li>
<li><p>如果程序是串行的，且推理+后处理&gt;40ms，那么一定会导致解码出错。解决方法是把解码用一个单独的线程并行。</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>单独解码、单独编码时，速度都能达到标称FPS或者路数，但编解码一起就达不到</dt><dd><ol class="arabic simple">
<li><p>VPU DDR带宽不够了</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>性能测试，达不到产品手册标称值</dt><dd><ol class="arabic simple">
<li><p>测试过程是否有报错信息，如果有，根据报错信息修改测试流程。</p></li>
<li><p>确认性能测试程序或者脚本是否开启了多线程，单线程无法充分发挥硬件性能，峰值性能需要在多线程下测得。</p></li>
<li><p>确认DDR interleave模式，不同模式下编解码性能有明显差异。</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
</section>
</section>
<section id="bmcv">
<h2><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">5.1.3. </span>BMCV问题</a><a class="headerlink" href="#bmcv" title="此标题的永久链接">¶</a></h2>
<ol class="arabic">
<li><p>send api error</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>硬件hang了，一般是TPU</p></li>
</ol>
</div></blockquote>
</li>
<li><p>bm_malloc_device_byte_heap error … bm_alloc_gmem failed, dev_id=xxx, size = 0x5eec00</p>
<ol class="arabic simple">
<li><p>这个错误一般是发生在给bm_image 分配内存时，显式或隐式地调用了alloc_dev_mem，所指定的heap可用内存不足了。一般是vpp heap，也就是 heap 1。</p></li>
<li><p>可以运行过程中观察 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cat</span> <span class="pre">/sys/kernel/debug/ion/bm_vpp_heap_dump/summary</span> <span class="pre">|</span> <span class="pre">head</span> <span class="pre">-2</span></code> ,usage 是否接近或者达到100%</p></li>
<li><p>size = 0x5eec0，报错中的size可以帮助定位具体是哪里分配内存失败了。 <code class="docutils literal notranslate"><span class="pre">0x5eec00=6,220,800=1920*1080*3</span></code> ，可以推断这是在分配一个类似于100p BGR_planar的图像内存； <code class="docutils literal notranslate"><span class="pre">2F7600=3,110,400=1920*1080*1.5</span></code>，1080p的YUV420图像。</p></li>
<li><p>解决方案主要是两方面：   1. 修改内存布局，见SDK手册； 2. 优化程序，特别是申请和释放内存相关的操作，长生命周期的内存，在程序开始统一申请，短生命周期的内存，及时释放。</p></li>
</ol>
</li>
<li><p>[BMCV][error] bm1684x vpp frame_idx 0, width or height abnormal,input[frame_idx].width 1920,input[frame_idx].height 1080,src_crop_rect[frame_idx].crop_w 34,src_crop_rect[frame_idx].crop_h 6,output[frame_idx].width 224, output[frame_idx].height 224,dst_crop_rect …</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>输入尺寸不符合要求。1684x vpp最小支持8x8。</p></li>
</ol>
</div></blockquote>
</li>
<li><p>[BMCV][error] src device memory start address not aligned, src_addr:4402c6a9f, bmcv_1684_vpp_internal.cpp: check_vpp_input_param</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>错误原因是input bm_image的设备内存起始地址没有对齐。vpp对起始地址有对齐要求。bmcv接口得到的一般是对齐的。可以用copyto一下，后续用新得到的bm_image。</p></li>
</ol>
</div></blockquote>
</li>
<li><p>使用bmcv的vpp_convert vpp_basic等接口转换出来的图片，与opencv.resize得到的图片，色彩有差异</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>原因在于bmcv默认的色彩转换矩阵csc mastrix与OpenCV不同。可以在vpp_basic等接口指定csc类型，或者自定义csc matrix</p></li>
</ol>
</div></blockquote>
</li>
</ol>
</section>
<section id="opencv">
<h2><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">5.1.4. </span>OpenCV问题</a><a class="headerlink" href="#opencv" title="此标题的永久链接">¶</a></h2>
<section id="id10">
<h3><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">5.1.4.1. </span>OpenCV拉流、解码</a><a class="headerlink" href="#id10" title="此标题的永久链接">¶</a></h3>
<ol class="arabic simple">
<li><dl class="simple">
<dt>maybe grab ends normally, retry count = 513</dt><dd><ol class="arabic simple">
<li><p>如果是文件一般是文件播放到末尾需调用VidoeCapture.release后重新VideoCapture.open。</p></li>
<li><p>如果是拉流，先确认两次read的时间间隔要小于帧间隔，比如对于25FPS的流，两次read小于40ms。</p></li>
<li><p>推流不稳定或者网络环境不稳定。可以用 <code class="docutils literal notranslate"><span class="pre">ffmpeg</span> <span class="pre">-rtsp_transport</span> <span class="pre">tcp</span> <span class="pre">-i</span> <span class="pre">&lt;rtsp://xxx&gt;</span> <span class="pre">-f</span> <span class="pre">rawvideo</span> <span class="pre">-y</span> <span class="pre">/dev/null</span></code> 长时间拉流测试，看是否会有报错。</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">5.1.4.2. </span>OpenCV图像处理</a><a class="headerlink" href="#id11" title="此标题的永久链接">¶</a></h3>
<ol class="arabic simple">
<li><dl class="simple">
<dt>“terminate called after throwing an instance of ‘cv::Exception’ what(): OpenCV(4.1.0) …… matrix.cpp:452: error: (-215:Assertion failed) u != 0 in function ‘creat’”</dt><dd><ol class="arabic simple">
<li><p>句柄数超过系统限制，ulimit -n。查看当前进程所使用的句柄数： <code class="docutils literal notranslate"><span class="pre">lsof</span> <span class="pre">-n|awk</span> <span class="pre">'{print</span> <span class="pre">$2}'|sort|uniq</span> <span class="pre">-c|sort</span> <span class="pre">-nr|more</span></code></p></li>
<li><p>vpp内存不足。 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cat</span> <span class="pre">/sys/kernel/debug/ion/bm_vpp_heap_dump/summary</span> <span class="pre">|</span> <span class="pre">head</span> <span class="pre">-2</span></code></p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>“Memory allocated by user, no device memory assigned. Not support BMCV!”</dt><dd><ol class="arabic simple">
<li><p>Mat只分配了系统内存，没有分配设备内存</p></li>
<li><p>如果是8UC3，需要s2d</p></li>
<li><p>如果是8UC1，请参考  <a class="reference internal" href="Multimedia_FAQ.html#uc1-general"><span class="std std-ref">8UC1问题FAQ</span></a></p></li>
</ol>
</dd>
</dl>
</li>
</ol>
</section>
</section>
<section id="sail">
<h2><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">5.1.5. </span>SAIL问题</a><a class="headerlink" href="#sail" title="此标题的永久链接">¶</a></h2>
<section id="sail-decoder">
<h3><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">5.1.5.1. </span>sail.Decoder解码</a><a class="headerlink" href="#sail-decoder" title="此标题的永久链接">¶</a></h3>
<ol class="arabic">
<li><p>VPU_DecGetOutputInfo decode fail framdIdx xxx error(0x00000000) reason(0x00400000), reasonExt(0x00000000)</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>sail.Decoder是单线程的，没有独立的解码进程。如果程序中解码后还有预处理、推理、后处理等流程，且耗时较长（&gt;1s/FPS），会导致Decoder.read()不及时，丢失数据，最终解码失败。</p></li>
<li><p>推荐使用sail.MultiDecoder替换sail.Decoder，MultiDecoder里面每个channel会单独开一个解码线程，解码线程把解码后的BMImage放到队列里，每次read是从队列里直接取BMImage。</p></li>
</ol>
</div></blockquote>
</li>
<li><p>bm1684x vpp When compressing the format, cropw requires 16 alignment, croph requires 4 alignment, and start_x requires 32 alignment.start_y requires 2 alignment</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>这个问题发生在使用了压缩格式时，即 <cite>sail.Decoder(path, compressed=True, dev_id)</cite>。</p></li>
<li><p>如果是24年4月之前的sail，建议升级到最新版，应该会解决这个问题。如果不方便升级，可以把True改成False。</p></li>
</ol>
</div></blockquote>
</li>
<li><p>拉流延迟较高</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>推流用RTSP，比RTMP延迟低</p></li>
<li><p>sail.set_decoder_env(“probesize”, “4096”)</p></li>
<li><p>sail.set_decoder_env(“analyzeduration”, “1000000”)</p></li>
</ol>
</div></blockquote>
</li>
</ol>
</section>
<section id="sail-encoder">
<h3><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">5.1.5.2. </span>sail.Encoder编码</a><a class="headerlink" href="#sail-encoder" title="此标题的永久链接">¶</a></h3>
<ol class="arabic simple">
<li><dl class="simple">
<dt>编码得到的视频，播放速度变快/看起来像加速了，或者总时长变短</dt><dd><ol class="arabic simple">
<li><p>Encoder内部用子线程编码，video_write()只负责送入队列。</p></li>
<li><p>送入队列的动作，有可能失败（比如队列满）。</p></li>
<li><p>如果不检查返回值，直接继续送下一帧，会导致很多失败的帧被丢掉，而编码的FPS不变，从最终结果上来看，像是视频加速了。 <em>假设一共有100个图像，编号1~100，我们希望编码一个25FPS的视频。假设write时所有偶数帧失败，共发生了50次失败，还剩50帧。   本来应该100frames / 25FPS = 4s播放的画面，2s就播完了，所以看起来像2倍速了。</em></p></li>
</ol>
</dd>
</dl>
</li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 不推荐的写法：</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">encoder</span><span class="o">.</span><span class="n">video_write</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="c1"># 推荐的写法：</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">ret</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">video_write</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><dl class="simple">
<dt>编码得到的视频，总帧数比video_write()的次数少</dt><dd><ol class="arabic simple">
<li><p>Encoder内部用子线程编码，video_write()只负责送入队列。</p></li>
<li><p>子线程在第一次video_write()时启动，启动需要短暂的时间。</p></li>
<li><p>如果编码帧数较少、write速度较快、Encoder很快退出，会导致有一部分BMImage来不及编码。</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
</section>
</section>
<section id="related-resources">
<h2><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">5.1.6. </span>Related Resources</a><a class="headerlink" href="#related-resources" title="此标题的永久链接">¶</a></h2>
<p><a class="reference external" href="https://doc.sophgo.com/sdk-docs/v23.09.01-lts/docs_latest_release/docs/libsophon/reference/html/index.html">BMLIB开发参考手册 – BMLIB-REFERENCE v23.10.01 文档 (sophgo.com)</a></p>
<p><a class="reference external" href="https://doc.sophgo.com/sdk-docs/v23.09.01-lts/docs_latest_release/docs/bmcv/reference/html/index.html">BMCV 开发参考手册 – BMCV v23.10.01 文档 (sophgo.com)</a></p>
<p><a class="reference external" href="https://doc.sophgo.com/sdk-docs/v23.09.01-lts/docs_latest_release/docs/sophon-mw/guide/html/index.html">多媒体开发参考手册 – Multimedia v23.10.01 文档 (sophgo.com)</a></p>
<p><a class="reference external" href="https://doc.sophgo.com/sdk-docs/v23.09.01-lts/docs_latest_release/docs/sophon-mw/manual/html/index.html">MULTIMEDIA使用手册 – Multimedia Manual 0.9.0 文档 (sophgo.com)</a></p>
<p><a class="reference external" href="https://doc.sophgo.com/sdk-docs/v23.09.01-lts/docs_latest_release/docs/sophon-mw/faq/html/index.html">多媒体客户常见问题手册 – Multimedia FAQ v23.10.01 文档 (sophgo.com)</a></p>
<p><a class="reference external" href="https://doc.sophgo.com/sdk-docs/v23.09.01-lts/docs_latest_release/docs/sophon-sail/docs/zh/html/index.html">SOPHON-SAIL 用户手册 – SOPHON-SAIL v23.10.01 文档 (sophgo.com)</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../5_multimedia.html" class="btn btn-neutral float-left" title="5. 多媒体用户常见问题" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Multimedia_FAQ.html" class="btn btn-neutral float-right" title="5.2. 多媒体客户常见问题" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, SOPHGO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>

    <ul id="scroll" class="bgt fds">
      <li><a class="scroll-home ms fo" href="https://www.sophgo.com/" rel="home" title="前往官网"><i class="be be-home"></i></a></li>
      <li><a class="scroll-home ms fo" href="https://developer.sophon.cn/document/index.html" rel="file" title="前往文档中心"><i class="be be-file"></i></a></li>
      <li><a class="scroll-h ms fo" title="页面顶部"><i class="be be-arrowup"></i></a></li>
      <li><a class="scroll-b ms fo" title="页面底部"><i class="be be-arrowdown"></i></a></li>
      <li class="qrshow">
        <a class="qrurl ms fo"><i class="be be-qr-code"></i></a>
        <span class="qrurl-box yy bk fd" style="display: none;">
          <img id="qrious">
          <p>本页二维码</p>
          <span class="arrow-right"></span>
        </span>
      </li>
    </ul>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>