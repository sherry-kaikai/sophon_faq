<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6.2. SOPHON DEMO 常见问题 &mdash; SOPHON and SDK FAQ master
 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" /><link rel="stylesheet" href="../_static/css/nav.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <script src="../_static/js/qrious.js"></script>
    <script src="../_static/js/nav.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="6.3. SOPHON STREAM 常见问题" href="sophon-stream-faq.html" />
    <link rel="prev" title="6.1. 程序优化常见问题" href="program_opt.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> SOPHON and SDK FAQ
          </a>
              <div class="version">
                master

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../0_disclaimer.html">1. 声明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1_basic_concept.html">2. 基础概念常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3_device_usages.html">3. 设备使用常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_converter_quantization.html">4. 模型转换及量化常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5_multimedia.html">5. 多媒体用户常见问题</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../6_program_optimization.html">6. 程序开发常见问题</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="program_opt.html">6.1. 程序优化常见问题</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.2. SOPHON DEMO 常见问题</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">6.2.1. 1 环境安装相关问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">6.2.1.1. 1.1 sophon-demo涉及的开发和运行环境安装可以参考相关文档。</a></li>
<li class="toctree-l4"><a class="reference internal" href="#socsd">6.2.1.2. 1.2 SoC模式下如何使用SD卡刷更新固件</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">6.2.2. 2 模型导出相关问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pytorchjit-trace">6.2.2.1. 2.1 Pytorch模型如何进行jit.trace</a></li>
<li class="toctree-l4"><a class="reference internal" href="#onnx">6.2.2.2. 2.2 ONNX模型导出过程使用的算子集</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">6.2.3. 3 模型编译和量化相关问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tpu-nntc">6.2.3.1. 3.1 使用TPU-NNTC量化的相关问题</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tpu-nntc-resnet260">6.2.3.2. 3.2 使用TPU-NNTC编译大模型(如resnet260)耗时长</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id6">6.2.4. 4 算法移植相关问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sophon-opencvopencvbmcv">6.2.4.1. 4.1 Sophon OpenCV和原生OpenCV、BMCV的关系</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opencvpythonsophon-opencv">6.2.4.2. 4.2 基于OpenCV的Python例程如何调用Sophon OpenCV进行加速</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opencvc-sophon-opencvopencv">6.2.4.3. 4.3 基于OpenCV的C++例程使用Sophon OpenCV还是原生OpenCV</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-ff-decodevid-reset-unlock-flock-failed">6.2.4.4. 4.4 C++例程使用ff_decode解码视频提示“vid reset unlock flock failed”，但不影响正常运行</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bm-free-device">6.2.4.5. 4.5 bm_free_device失败</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">6.2.5. 5 精度测试相关问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fp32-bmodel">6.2.5.1. 5.1 FP32 BModel的推理结果与原模型的推理结果不一致</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id8">6.2.6. 6 性能测试相关问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fp32-bmodelbm1684xbm1684">6.2.6.1. 6.1 部分FP32 BModel的BM1684X性能低于BM1684</a></li>
<li class="toctree-l4"><a class="reference internal" href="#opencv-pythonint8bmodelfp32bmodel">6.2.6.2. 6.2 基于opencv-python的例程int8bmodel推理时间没有比fp32bmodel快</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">6.2.6.3. 6.3 sophon-demo能否用于性能压测</a></li>
<li class="toctree-l4"><a class="reference internal" href="#readme">6.2.6.4. 6.4 测试性能相比README下降</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">6.2.6.5. 6.5 性能测试表格的作用</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id11">6.2.7. 7 其他问题</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#unkown-cmake-command-add-compile-definitions">6.2.7.1. 7.1 编译时出现<code class="docutils literal notranslate"><span class="pre">Unkown</span> <span class="pre">CMake</span> <span class="pre">command</span> <span class="pre">&quot;add_compile_definitions&quot;.</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">6.2.7.2. 7.2 有些图片的数据重叠到一起，有的图片框上面没数据，有些图片没有框</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bm-ion-alloc-failed">6.2.7.3. 7.3 程序运行时出现<code class="docutils literal notranslate"><span class="pre">bm_ion_alloc</span> <span class="pre">failed</span></code>等报错</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">6.2.7.4. 7.4 刚开机首次执行某个函数慢(比如解码)，重启进程再次运行程序，时间正常</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scripts-download-sh">6.2.7.5. 7.5 运行下载脚本<code class="docutils literal notranslate"><span class="pre">scripts/download.sh</span></code>报错</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pycocotoolspip-requireddependencyexception-jpeg">6.2.7.6. 7.6 pycocotools等包通过pip安装失败，报错中含有<code class="docutils literal notranslate"><span class="pre">RequiredDependencyException:</span> <span class="pre">jpeg</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">6.2.7.7. 7.7 解码超过一定路数开始报错，但是设备内存没有满</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sophon-stream-faq.html">6.3. SOPHON STREAM 常见问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="sophon-pipeline-faq.html">6.4. SOPHON PIPELINE 常见问题及解答</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SOPHON and SDK FAQ</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../6_program_optimization.html"><span class="section-number">6. </span>程序开发常见问题</a> &raquo;</li>
      <li><span class="section-number">6.2. </span>SOPHON DEMO 常见问题</li>
      <li class="wy-breadcrumbs-aside">
            <!-- <a href="../_sources/program_develop/sophon-demo-faq.rst.txt" rel="nofollow"> View page source</a> -->
            <a href="https://developer.sophon.cn/document/index.html" rel="nofollow">返回文档中心</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sophon-demo">
<h1><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">6.2. </span>SOPHON DEMO 常见问题</a><a class="headerlink" href="#sophon-demo" title="此标题的永久链接">¶</a></h1>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p>本篇内容和 sophon-demo/docs/FAQ 内容一样，本篇与其重复只是为了方便查找。
原文地址：<a class="reference external" href="https://github.com/sophgo/sophon-demo/tree/release/docs">https://github.com/sophgo/sophon-demo/tree/release/docs</a></p>
</div>
<nav class="contents" id="id1">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#sophon-demo" id="id15">SOPHON DEMO 常见问题</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id16">1 环境安装相关问题</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id17">1.1 sophon-demo涉及的开发和运行环境安装可以参考相关文档。</a></p></li>
<li><p><a class="reference internal" href="#socsd" id="id18">1.2 SoC模式下如何使用SD卡刷更新固件</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id4" id="id19">2 模型导出相关问题</a></p>
<ul>
<li><p><a class="reference internal" href="#pytorchjit-trace" id="id20">2.1 Pytorch模型如何进行jit.trace</a></p></li>
<li><p><a class="reference internal" href="#onnx" id="id21">2.2 ONNX模型导出过程使用的算子集</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id22">3 模型编译和量化相关问题</a></p>
<ul>
<li><p><a class="reference internal" href="#tpu-nntc" id="id23">3.1 使用TPU-NNTC量化的相关问题</a></p></li>
<li><p><a class="reference internal" href="#tpu-nntc-resnet260" id="id24">3.2 使用TPU-NNTC编译大模型(如resnet260)耗时长</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id6" id="id25">4 算法移植相关问题</a></p>
<ul>
<li><p><a class="reference internal" href="#sophon-opencvopencvbmcv" id="id26">4.1 Sophon OpenCV和原生OpenCV、BMCV的关系</a></p></li>
<li><p><a class="reference internal" href="#opencvpythonsophon-opencv" id="id27">4.2 基于OpenCV的Python例程如何调用Sophon OpenCV进行加速</a></p></li>
<li><p><a class="reference internal" href="#opencvc-sophon-opencvopencv" id="id28">4.3 基于OpenCV的C++例程使用Sophon OpenCV还是原生OpenCV</a></p></li>
<li><p><a class="reference internal" href="#c-ff-decodevid-reset-unlock-flock-failed" id="id29">4.4 C++例程使用ff_decode解码视频提示“vid reset unlock flock failed”，但不影响正常运行</a></p></li>
<li><p><a class="reference internal" href="#bm-free-device" id="id30">4.5 bm_free_device失败</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id31">5 精度测试相关问题</a></p>
<ul>
<li><p><a class="reference internal" href="#fp32-bmodel" id="id32">5.1 FP32 BModel的推理结果与原模型的推理结果不一致</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id8" id="id33">6 性能测试相关问题</a></p>
<ul>
<li><p><a class="reference internal" href="#fp32-bmodelbm1684xbm1684" id="id34">6.1 部分FP32 BModel的BM1684X性能低于BM1684</a></p></li>
<li><p><a class="reference internal" href="#opencv-pythonint8bmodelfp32bmodel" id="id35">6.2 基于opencv-python的例程int8bmodel推理时间没有比fp32bmodel快</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id36">6.3 sophon-demo能否用于性能压测</a></p></li>
<li><p><a class="reference internal" href="#readme" id="id37">6.4 测试性能相比README下降</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id38">6.5 性能测试表格的作用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id11" id="id39">7 其他问题</a></p>
<ul>
<li><p><a class="reference internal" href="#unkown-cmake-command-add-compile-definitions" id="id40">7.1 编译时出现<code class="docutils literal notranslate"><span class="pre">Unkown</span> <span class="pre">CMake</span> <span class="pre">command</span> <span class="pre">&quot;add_compile_definitions&quot;.</span></code></a></p></li>
<li><p><a class="reference internal" href="#id12" id="id41">7.2 有些图片的数据重叠到一起，有的图片框上面没数据，有些图片没有框</a></p></li>
<li><p><a class="reference internal" href="#bm-ion-alloc-failed" id="id42">7.3 程序运行时出现<code class="docutils literal notranslate"><span class="pre">bm_ion_alloc</span> <span class="pre">failed</span></code>等报错</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id43">7.4 刚开机首次执行某个函数慢(比如解码)，重启进程再次运行程序，时间正常</a></p></li>
<li><p><a class="reference internal" href="#scripts-download-sh" id="id44">7.5 运行下载脚本<code class="docutils literal notranslate"><span class="pre">scripts/download.sh</span></code>报错</a></p></li>
<li><p><a class="reference internal" href="#pycocotoolspip-requireddependencyexception-jpeg" id="id45">7.6 pycocotools等包通过pip安装失败，报错中含有<code class="docutils literal notranslate"><span class="pre">RequiredDependencyException:</span> <span class="pre">jpeg</span></code></a></p></li>
<li><p><a class="reference internal" href="#id14" id="id46">7.7 解码超过一定路数开始报错，但是设备内存没有满</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<p>我们列出了一些用户和开发者在开发过程中会遇到的常见问题以及对应的解决方案，如果您发现了任何问题，请随时联系我们或创建相关issue，非常欢迎您提出的任何问题或解决方案。</p>
<section id="id2">
<h2><a class="toc-backref" href="#id16" role="doc-backlink"><span class="section-number">6.2.1. </span>1 环境安装相关问题</a><a class="headerlink" href="#id2" title="此标题的永久链接">¶</a></h2>
<section id="id3">
<h3><span class="section-number">6.2.1.1. </span>1.1 sophon-demo涉及的开发和运行环境安装可以参考<a class="reference external" href="./Environment_Install_Guide.md">相关文档</a>。<a class="headerlink" href="#id3" title="此标题的永久链接">¶</a></h3>
</section>
<section id="socsd">
<h3><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">6.2.1.2. </span>1.2 SoC模式下如何使用SD卡刷更新固件</a><a class="headerlink" href="#socsd" title="此标题的永久链接">¶</a></h3>
<p>下载解压v22.09.02以后的SophonSDK，找到sophon-img文件夹下的sdcard刷机包，并参考<a class="reference external" href="https://doc.sophgo.com/docs/3.0.0/docs_latest_release/faq/html/devices/SOC/soc_firmware_update.html#id6">相关文档</a>刷新固件。</p>
</section>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">6.2.2. </span>2 模型导出相关问题</a><a class="headerlink" href="#id4" title="此标题的永久链接">¶</a></h2>
<section id="pytorchjit-trace">
<h3><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">6.2.2.1. </span>2.1 Pytorch模型如何进行jit.trace</a><a class="headerlink" href="#pytorchjit-trace" title="此标题的永久链接">¶</a></h3>
<p><strong>如果您使用TPU-NNTC来编译BModel，注意在TPU-NNTC支持的Pytorch版本``1.8.0+cpu``的环境下进行torchscript模型导出。</strong>
部分开源仓库提供了模型导出的脚本，如果没有则需要参考<a class="reference external" href="./torch.jit.trace_Guide.md">相关文档</a>或者<a class="reference external" href="https://pytorch.org/docs/stable/jit.html">Pytorch官方文档</a>编写jit.trace脚本。jit.trace通常是在模型开发(torch)环境中进行，不需要安装SophonSDK。
-
YOLOv5模型jit.trace的方法可参考<a class="reference external" href="../sample/YOLOv5/docs/YOLOv5_Export_Guide.md">相关文档</a></p>
</section>
<section id="onnx">
<h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">6.2.2.2. </span>2.2 ONNX模型导出过程使用的算子集</a><a class="headerlink" href="#onnx" title="此标题的永久链接">¶</a></h3>
<p>如果pytorch版本过低，可能无法支持高版本ONNX算子集，导致ONNX输出失败。
需要根据当前环境使用pytorch版本，设置支持的ONNX算子集版本。以设置使用ONNX算子集版本13为例，设置方式如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span>
    <span class="o">...</span>
    <span class="n">opset_version</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id22" role="doc-backlink"><span class="section-number">6.2.3. </span>3 模型编译和量化相关问题</a><a class="headerlink" href="#id5" title="此标题的永久链接">¶</a></h2>
<section id="tpu-nntc">
<h3><a class="toc-backref" href="#id23" role="doc-backlink"><span class="section-number">6.2.3.1. </span>3.1 使用TPU-NNTC量化的相关问题</a><a class="headerlink" href="#tpu-nntc" title="此标题的永久链接">¶</a></h3>
<p>详见<a class="reference external" href="./Calibration_Guide.md">相关文档</a>。</p>
</section>
<section id="tpu-nntc-resnet260">
<h3><a class="toc-backref" href="#id24" role="doc-backlink"><span class="section-number">6.2.3.2. </span>3.2 使用TPU-NNTC编译大模型(如resnet260)耗时长</a><a class="headerlink" href="#tpu-nntc-resnet260" title="此标题的永久链接">¶</a></h3>
<p>resnet260编译会这么耗时有可能是二次搜索时间太长的原因。我们在做编译优化的时候对已经做完初次layergroup后又结果做一次再分组搜索，这个搜索结果对于resnet这类网络性能收益不大，反倒会增加编译优化的时间。为了解决这类模型问题，我们增加了二次搜索的上限值，通过以下环境变量来控制二次搜索的上限：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">BMCOMPILER_GROUP_SEARCH_COUNT</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</section>
</section>
<section id="id6">
<h2><a class="toc-backref" href="#id25" role="doc-backlink"><span class="section-number">6.2.4. </span>4 算法移植相关问题</a><a class="headerlink" href="#id6" title="此标题的永久链接">¶</a></h2>
<section id="sophon-opencvopencvbmcv">
<h3><a class="toc-backref" href="#id26" role="doc-backlink"><span class="section-number">6.2.4.1. </span>4.1 Sophon OpenCV和原生OpenCV、BMCV的关系</a><a class="headerlink" href="#sophon-opencvopencvbmcv" title="此标题的永久链接">¶</a></h3>
<p>Sophon
OpenCV继承和优化了原生OpenCV，修改了原生mat，增加了设备内存，部分接口（如imread，videocapture，videowriter，resize，convert等）增加了硬件加速支持，保持了跟原生OpenCV操作的接口一致性，修改内容具体信息请查看<a class="reference external" href="https://doc.sophgo.com/sdk-docs/v22.12.01/docs_latest_release/docs/sophon-mw/guide/html/1_guide.html">相关文档</a>。</p>
<p>BMCV是我们提供的一套基于硬件VPP和TPU进行图像处理以及部分数学运算的加速库，是C接口的库。在我们修改的Sophon
OpenCV底层，相关操作的硬件加速调用的也是BMCV的接口。</p>
<p>Sophon
OpenCV使用TPU中的硬件加速单元进行解码，相比原生OpenCV采用了不同的upsample算法，解码和前后处理的方式与原生的OpenCV存在一定差异，可能影响最终的预测结果，但通常不会对鲁棒性好的模型造成明显影响。</p>
</section>
<section id="opencvpythonsophon-opencv">
<h3><a class="toc-backref" href="#id27" role="doc-backlink"><span class="section-number">6.2.4.2. </span>4.2 基于OpenCV的Python例程如何调用Sophon OpenCV进行加速</a><a class="headerlink" href="#opencvpythonsophon-opencv" title="此标题的永久链接">¶</a></h3>
<p>使用v22.09.02以后的SophonSDK，不管是PCIe，还是SoC模式，基于OpenCV的Python例程默认都使用安装的原生OpenCV，可以通过设置环境变量使用Sophon
OpenCV：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$PYTHONPATH</span>:/opt/sophon/sophon-opencv-latest/opencv-python/
</pre></div>
</div>
<p>注意使用sophon-opencv可能会导致推理结果的差异。</p>
</section>
<section id="opencvc-sophon-opencvopencv">
<h3><a class="toc-backref" href="#id28" role="doc-backlink"><span class="section-number">6.2.4.3. </span>4.3 基于OpenCV的C++例程使用Sophon OpenCV还是原生OpenCV</a><a class="headerlink" href="#opencvc-sophon-opencvopencv" title="此标题的永久链接">¶</a></h3>
<p>基于OpenCV的C++例程在CMakeLists.txt中设置了OpenCV_DIR路径，链接Sophon
OpenCV的相关头文件和库文件。如果需要调用原生OpenCV，需自行安装原生OpenCV，并修改相关链接路径。</p>
</section>
<section id="c-ff-decodevid-reset-unlock-flock-failed">
<h3><a class="toc-backref" href="#id29" role="doc-backlink"><span class="section-number">6.2.4.4. </span>4.4 C++例程使用ff_decode解码视频提示“vid reset unlock flock failed”，但不影响正常运行</a><a class="headerlink" href="#c-ff-decodevid-reset-unlock-flock-failed" title="此标题的永久链接">¶</a></h3>
<p>这是由于缓存没有及时清除导致的，不影响推理结果。可以通过运行如下命令解决：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>rm<span class="w"> </span>/tmp/vid_*
</pre></div>
</div>
</section>
<section id="bm-free-device">
<h3><a class="toc-backref" href="#id30" role="doc-backlink"><span class="section-number">6.2.4.5. </span>4.5 bm_free_device失败</a><a class="headerlink" href="#bm-free-device" title="此标题的永久链接">¶</a></h3>
<p>可能的原因： 1. 这块device_mem没有被分配过内存，或者已经被释放过。</p>
<ol class="arabic simple" start="2">
<li><p>如果一个bm_image的内存是attach过来的，注意只调用detach函数就好，不要调用bm_image_free_contiguous_mem释放它，否则后续那块device_mem会释放失败。</p></li>
</ol>
</section>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id31" role="doc-backlink"><span class="section-number">6.2.5. </span>5 精度测试相关问题</a><a class="headerlink" href="#id7" title="此标题的永久链接">¶</a></h2>
<section id="fp32-bmodel">
<h3><a class="toc-backref" href="#id32" role="doc-backlink"><span class="section-number">6.2.5.1. </span>5.1 FP32 BModel的推理结果与原模型的推理结果不一致</a><a class="headerlink" href="#fp32-bmodel" title="此标题的永久链接">¶</a></h3>
<p>在前后处理与原算法对齐的前提下，FP32
BModel的精度与原模型的最大误差通常在0.001以下，不会对最终的预测结果造成影响。FP32
BModel精度对齐的方法可以参考<a class="reference external" href="./FP32BModel_Precise_Alignment.md">相关文档</a>。</p>
</section>
</section>
<section id="id8">
<h2><a class="toc-backref" href="#id33" role="doc-backlink"><span class="section-number">6.2.6. </span>6 性能测试相关问题</a><a class="headerlink" href="#id8" title="此标题的永久链接">¶</a></h2>
<section id="fp32-bmodelbm1684xbm1684">
<h3><a class="toc-backref" href="#id34" role="doc-backlink"><span class="section-number">6.2.6.1. </span>6.1 部分FP32 BModel的BM1684X性能低于BM1684</a><a class="headerlink" href="#fp32-bmodelbm1684xbm1684" title="此标题的永久链接">¶</a></h3>
<p>BM1684X的local
memory相比BM1684少了一半，参数量较大的模型有可能放不下，导致gdma访问ddr次数大量增加。</p>
</section>
<section id="opencv-pythonint8bmodelfp32bmodel">
<h3><a class="toc-backref" href="#id35" role="doc-backlink"><span class="section-number">6.2.6.2. </span>6.2 基于opencv-python的例程int8bmodel推理时间没有比fp32bmodel快</a><a class="headerlink" href="#opencv-pythonint8bmodelfp32bmodel" title="此标题的永久链接">¶</a></h3>
<div class="line-block">
<div class="line">int8bmodel的输入层数据类型是int8，scale不等1，基于opencv-python的例程以numpy.array为输入，推理接口内部需要进行乘scale操作，而fp32bmodel输入层的scale是1，推理接口内部不需要进行乘scale操作，这部分时间可能会抵掉模型推理优化的时间。可以在代码中添加<code class="docutils literal notranslate"><span class="pre">sail.set_print_flag(1)</span></code>，打印推理接口的具体耗时。</div>
<div class="line">如果要使用opencv-python例程进行部署，建议将int8bmodel的输入、输出层保留为浮点计算。</div>
</div>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id36" role="doc-backlink"><span class="section-number">6.2.6.3. </span>6.3 sophon-demo能否用于性能压测</a><a class="headerlink" href="#id9" title="此标题的永久链接">¶</a></h3>
<p>不建议。sophon-demo提供一系列主流算法的移植例程，用户可以根据sophon-demo进行模型算法移植和精度测试。但sophon-demo的前处理/推理/后处理是串行的，即使开多个进程也很难将TPU的性能充分发挥出来。<a class="reference external" href="https://github.com/sophgo/sophon-pipeline">sophon-pipeline</a>能够将前处理/推理/后处理分别运行在3个线程上，最大化的实现并行，因此建议使用sophon-pipeline进行性能压测。</p>
</section>
<section id="readme">
<h3><a class="toc-backref" href="#id37" role="doc-backlink"><span class="section-number">6.2.6.4. </span>6.4 测试性能相比README下降</a><a class="headerlink" href="#readme" title="此标题的永久链接">¶</a></h3>
<p>如果性能下降超过10%，需要确认产品型号，sophon-demo的各个例程都是基于标准版的产品（如SE-16）来测试的，如果您使用的是低配版产品（如SE5-8），性能下降是正常的，SE5-16的int8算力是17.6TOPS，SE5-8是10.6TOPS，所以大概会有2/5的性能损失。
如果您使用的产品也是标准版，也遇到了性能下降的问题，可以将问题反馈给算能工作人员或者在github上创建issue。</p>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id38" role="doc-backlink"><span class="section-number">6.2.6.5. </span>6.5 性能测试表格的作用</a><a class="headerlink" href="#id10" title="此标题的永久链接">¶</a></h3>
<p>sophon-demo提供的性能测试表格一般包含解码、前处理、推理、后处理这四个部分，业界对于算法部署也大多是这么划分的。对于算能的AI处理器而言，这四个部分都是可以并发的，因为它们各自依赖的器件不同，比如解码依赖VPU、前处理依赖VPP、推理依赖TPU、后处理则依赖中央处理器，这些元器件是可以并发工作且不会受到各自影响的。sophon-demo提供的性能测试表格将这些信息列出来，可以直观地分析出当前算法的瓶颈以及它能达到的理论最高每秒处理次数。</p>
</section>
</section>
<section id="id11">
<h2><a class="toc-backref" href="#id39" role="doc-backlink"><span class="section-number">6.2.7. </span>7 其他问题</a><a class="headerlink" href="#id11" title="此标题的永久链接">¶</a></h2>
<section id="unkown-cmake-command-add-compile-definitions">
<h3><a class="toc-backref" href="#id40" role="doc-backlink"><span class="section-number">6.2.7.1. </span>7.1 编译时出现<code class="docutils literal notranslate"><span class="pre">Unkown</span> <span class="pre">CMake</span> <span class="pre">command</span> <span class="pre">&quot;add_compile_definitions&quot;.</span></code></a><a class="headerlink" href="#unkown-cmake-command-add-compile-definitions" title="此标题的永久链接">¶</a></h3>
<p>这是你的cmake没有add_compile_definition这个函数，可以修改成add_definitions，或者升级cmake到3.12之后。</p>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id41" role="doc-backlink"><span class="section-number">6.2.7.2. </span>7.2 有些图片的数据重叠到一起，有的图片框上面没数据，有些图片没有框</a><a class="headerlink" href="#id12" title="此标题的永久链接">¶</a></h3>
<p>图片和视频测试结果存在少数的漏检、误检，这是正常的，sophon-demo的例程只需要保证移植后的模型和源模型的精度可以对齐就行了，判断模型效果应当以精度指标测试为准。</p>
</section>
<section id="bm-ion-alloc-failed">
<h3><a class="toc-backref" href="#id42" role="doc-backlink"><span class="section-number">6.2.7.3. </span>7.3 程序运行时出现<code class="docutils literal notranslate"><span class="pre">bm_ion_alloc</span> <span class="pre">failed</span></code>等报错</a><a class="headerlink" href="#bm-ion-alloc-failed" title="此标题的永久链接">¶</a></h3>
<p>首先排查程序是否出现设备内存泄漏，代码中是否存在分配设备内存没有及时释放的问题。如果确认没有内存泄漏，那么可能是由于某个heap太小导致的，可以观察一下设备内存各个heap的使用情况：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#在SE5/SE7系列上使用以下命令查看：</span>
sudo<span class="w"> </span>cat<span class="w"> </span>/sys/kernel/debug/ion/bm_vpu_heap_dump/summary
sudo<span class="w"> </span>cat<span class="w"> </span>/sys/kernel/debug/ion/bm_vpp_heap_dump/summary
sudo<span class="w"> </span>cat<span class="w"> </span>/sys/kernel/debug/ion/bm_npu_heap_dump/summary
<span class="c1">#在SE9上使用以下命令查看：</span>
sudo<span class="w"> </span>cat<span class="w"> </span>/sys/kernel/debug/ion/cvi_vpp_heap_dump/summary
sudo<span class="w"> </span>cat<span class="w"> </span>/sys/kernel/debug/ion/cvi_npu_heap_dump/summary
<span class="c1">#会打印类似这种信息</span>
Summary:
<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span>vpp<span class="w"> </span>heap<span class="w"> </span>size:4294967296<span class="w"> </span>bytes,<span class="w"> </span>used:144646144<span class="w"> </span>bytes
usage<span class="w"> </span>rate:4%,<span class="w"> </span>memory<span class="w"> </span>usage<span class="w"> </span>peak<span class="w"> </span><span class="m">144646144</span><span class="w"> </span>bytes<span class="w"> </span><span class="c1">#memory usage peak是该heap的内存使用峰值</span>
</pre></div>
</div>
<p>如果某个heap的<code class="docutils literal notranslate"><span class="pre">memory</span> <span class="pre">usage</span> <span class="pre">peak</span></code>已经接近<code class="docutils literal notranslate"><span class="pre">heap</span> <span class="pre">size</span></code>了，那么可以考虑用这个工具调整设备内存各个heap的大小：<a class="reference external" href="https://doc.sophgo.com/sdk-docs/v23.07.01/docs_latest_release/docs/SophonSDK_doc/zh/html/appendix/2_mem_edit_tools.html">sophon内存修改工具</a>。</p>
</section>
<section id="id13">
<h3><a class="toc-backref" href="#id43" role="doc-backlink"><span class="section-number">6.2.7.4. </span>7.4 刚开机首次执行某个函数慢(比如解码)，重启进程再次运行程序，时间正常</a><a class="headerlink" href="#id13" title="此标题的永久链接">¶</a></h3>
<p>可能是因为文件还没有缓存到内存中导致的刚开始比较慢。
可以做个验证，如果不重启可复现，就说明是刚开机运行程序比较慢，是文件还没缓存的原因，步骤如下：</p>
<ol class="arabic simple">
<li><p>上电后执行程序，第一次执行慢，第二次执行正常。</p></li>
<li><p>之后进入root用户清除cache，运行命令<code class="docutils literal notranslate"><span class="pre">echo</span> <span class="pre">3</span> <span class="pre">&gt;</span> <span class="pre">/proc/sys/vm/drop_caches</span></code>。</p></li>
<li><p>再次执行程序，运行慢，即可确定是cache导致的。</p></li>
</ol>
</section>
<section id="scripts-download-sh">
<h3><a class="toc-backref" href="#id44" role="doc-backlink"><span class="section-number">6.2.7.5. </span>7.5 运行下载脚本<code class="docutils literal notranslate"><span class="pre">scripts/download.sh</span></code>报错</a><a class="headerlink" href="#scripts-download-sh" title="此标题的永久链接">¶</a></h3>
<p>可能有以下原因：</p>
<ol class="arabic">
<li><p>网络环境不好或者有防火墙。</p></li>
<li><p>一般下载脚本会最先安装dfss，如果是非ubuntu系统出现dfss安装失败，中间可能会打印类似<code class="docutils literal notranslate"><span class="pre">ERROR:</span> <span class="pre">Failed</span> <span class="pre">building</span> <span class="pre">wheel</span> <span class="pre">for</span> <span class="pre">cff</span></code>这种报错，这是因为缺少libffi-devel这个依赖，可以通过以下命令安装：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>libffi-devel
<span class="c1">#然后重新运行下载脚本</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="pycocotoolspip-requireddependencyexception-jpeg">
<h3><a class="toc-backref" href="#id45" role="doc-backlink"><span class="section-number">6.2.7.6. </span>7.6 pycocotools等包通过pip安装失败，报错中含有<code class="docutils literal notranslate"><span class="pre">RequiredDependencyException:</span> <span class="pre">jpeg</span></code></a><a class="headerlink" href="#pycocotoolspip-requireddependencyexception-jpeg" title="此标题的永久链接">¶</a></h3>
<p>该问题可能会发生在Risc-V架构的机器上，如SG2042，可以通过以下方法解决：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dnf<span class="w"> </span>install<span class="w"> </span>libjpeg-turbo-devel<span class="w"> </span><span class="c1">#如果是fedora系统</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libjpeg-dev<span class="w"> </span><span class="c1">#如果是ubuntu系统</span>
</pre></div>
</div>
</section>
<section id="id14">
<h3><a class="toc-backref" href="#id46" role="doc-backlink"><span class="section-number">6.2.7.7. </span>7.7 解码超过一定路数开始报错，但是设备内存没有满</a><a class="headerlink" href="#id14" title="此标题的永久链接">¶</a></h3>
<p>很可能是因为fd数量不足问题，使用ulimit -n
65536解决，如果还是不够可以调地更大，注意，ulimit -n只在当前终端生效。</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="program_opt.html" class="btn btn-neutral float-left" title="6.1. 程序优化常见问题" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sophon-stream-faq.html" class="btn btn-neutral float-right" title="6.3. SOPHON STREAM 常见问题" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, SOPHGO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>

    <ul id="scroll" class="bgt fds">
      <li><a class="scroll-home ms fo" href="https://www.sophgo.com/" rel="home" title="前往官网"><i class="be be-home"></i></a></li>
      <li><a class="scroll-home ms fo" href="https://developer.sophon.cn/document/index.html" rel="file" title="前往文档中心"><i class="be be-file"></i></a></li>
      <li><a class="scroll-h ms fo" title="页面顶部"><i class="be be-arrowup"></i></a></li>
      <li><a class="scroll-b ms fo" title="页面底部"><i class="be be-arrowdown"></i></a></li>
      <li class="qrshow">
        <a class="qrurl ms fo"><i class="be be-qr-code"></i></a>
        <span class="qrurl-box yy bk fd" style="display: none;">
          <img id="qrious">
          <p>本页二维码</p>
          <span class="arrow-right"></span>
        </span>
      </li>
    </ul>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>